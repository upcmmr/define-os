<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Screenshot Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body class="bg-white text-gray-900">
    <!-- Header with URL input -->
    <div class="bg-gray-50 border-b border-gray-200 p-4">
        <div class="max-w-6xl mx-auto flex justify-center">
            <div class="flex items-center">
                <input type="text" id="urlInput" placeholder="Enter URL" 
                       class="w-96 px-4 py-2 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button onclick="processUrl()" id="submitBtn" 
                        class="ml-3 px-6 py-2 text-lg bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Main layout with sidebar and content -->
    <div class="flex min-h-screen">
        <!-- Left sidebar navigation -->
        <div id="sidebar" class="w-48 bg-gray-100 border-r border-gray-200 p-4" style="display: none;">
            <!-- Sidebar content will be dynamically generated by updateSidebarForAnalysis() -->
        </div>

        <!-- Main content area -->
        <div class="flex-1 p-8">
            <div id="results"></div>
        </div>
    </div>

    <script>
        // Constants
        const UI_UPDATE_DELAY = 100; // milliseconds for DOM updates
        
        // DOM Cache
        let navLinksCache = null;
        let resultsElement = null;
        let sidebarElement = null;
        
        // Helper function to get cached results element
        function getResultsElement() {
            if (!resultsElement) {
                resultsElement = document.getElementById('results');
            }
            return resultsElement;
        }
        
        // Helper function to get cached sidebar element
        function getSidebarElement() {
            if (!sidebarElement) {
                sidebarElement = document.getElementById('sidebar');
            }
            return sidebarElement;
        }
        
        // Helper function to get cached nav links
        function getNavLinks() {
            if (!navLinksCache || navLinksCache.length === 0) {
                navLinksCache = document.querySelectorAll('.nav-link');
            }
            return navLinksCache;
        }
        
        // Helper function to clear nav links cache (call when sidebar is updated)
        function clearNavLinksCache() {
            navLinksCache = null;
        }
        
        // Helper function to update navigation active state
        function updateNavActiveState(activeElement = null) {
            getNavLinks().forEach(link => {
                link.classList.remove('bg-blue-100', 'text-blue-700');
                link.classList.add('text-gray-700');
            });
            
            if (activeElement) {
                activeElement.classList.remove('text-gray-700');
                activeElement.classList.add('bg-blue-100', 'text-blue-700');
            }
        }
        
        async function processUrl() {
            const url = document.getElementById('urlInput').value.trim();
            const urlInput = document.getElementById('urlInput');
            const submitBtn = document.getElementById('submitBtn');
            const results = document.getElementById('results');
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            // Disable input and button after submission
            urlInput.disabled = true;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Discovering Links...';
            
            // Phase 1: Discover links
            results.innerHTML = '<div class="flex items-center justify-center py-8"><div class="text-lg text-gray-600">Capturing screenshots and discovering links...</div></div>';
            
            console.log('Starting link discovery for URL:', url);
            
            try {
                const response = await fetch('/discover-links', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url })
                });
                
                console.log('Discover links response status:', response.status);
                const data = await response.json();
                console.log('Discover links response data:', data);
                
                if (data.success) {
                    console.log('Link discovery successful. Links data:', data.links);
                    appState.phase = 'link-discovery';
                    appState.discoveryData = data;
                    displayLinkDiscovery(data);
                } else {
                    console.error('Link discovery failed:', data.error);
                    results.innerHTML = `<p class="text-red-600">Error: ${data.error}</p>`;
                }
                
            } catch (error) {
                console.error('Link discovery request failed:', error);
                results.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
            }
        }

        function displayLinkDiscovery(data) {
            // Show sidebar with Site Links only
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = 'block';
            sidebar.innerHTML = `
                <nav>
                    <div class="mb-4">
                        <a href="#" onclick="showLinkDiscovery()" class="nav-link block px-3 py-2 rounded-md text-sm font-medium bg-blue-100 text-blue-700">
                            Site Links
                        </a>
                    </div>
                </nav>
            `;
            
            showLinkDiscovery();
        }

        function showLinkDiscovery() {
            const results = document.getElementById('results');
            const data = appState.discoveryData;
            
            if (!data) return;
            
            let html = `
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Site Links</h2>
                    
                    <!-- Two column layout: images left, links right -->
                    <div class="grid grid-cols-2 gap-8">
                        <!-- Left column: Screenshots stacked vertically -->
                        <div class="space-y-6">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Header</h2>
                                <img src="${data.images.header}" alt="Header screenshot" class="w-full h-auto shadow-lg rounded-lg border">
                            </div>
                            <div>
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Body</h2>
                                <img src="${data.images.body}" alt="Body screenshot" class="w-full h-auto shadow-lg rounded-lg border">
                            </div>
                            <div>
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Footer</h2>
                                <img src="${data.images.footer}" alt="Footer screenshot" class="w-full h-auto shadow-lg rounded-lg border">
                            </div>
                        </div>
                        
                        <!-- Right column: Links selection -->
                        <div class="bg-white p-6 rounded-lg border h-fit">
                            <!-- Progress widget (hidden initially) -->
                            <div id="progressWidget" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg" style="display: none;">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-blue-800">Analysis Progress</h3>
                                    <div id="progressIndicator" class="text-sm text-blue-600">0 of 0 completed</div>
                                </div>
                                
                                <div class="w-full bg-blue-200 rounded-full h-2 mb-3">
                                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                
                                <div id="currentlyProcessing" class="text-sm text-blue-700">Starting analysis...</div>
                                
                                <div id="completedPages" class="mt-4">
                                    <div id="completedList" class="space-y-1"></div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-semibold text-gray-800">Select Pages to Analyze</h2>
                                <button onclick="startAnalysis()" id="analyzeBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Analyze
                                </button>
                            </div>
                            
                            <div id="linksContainer">
                                ${formatSelectableLinks(data.links)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            results.innerHTML = html;
            
            // Ensure URL input and submit button remain disabled after initial submission
            if (appState.phase === 'link-discovery' || appState.phase === 'analysis-results') {
                setTimeout(() => {
                    const urlInput = document.getElementById('urlInput');
                    const submitBtn = document.getElementById('submitBtn');
                    
                    if (urlInput) {
                        urlInput.disabled = true;
                    }
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = appState.phase === 'analysis-results' ? 'Analysis Complete' : 'Discovering Links...';
                    }
                }, 50);
            }
            
            // If analysis was completed, restore the completed state
            if (appState.phase === 'analysis-results' && appState.analysisResults && Object.keys(appState.analysisResults).length > 0) {
                // Simulate completion data
                const completionData = {
                    totalCompleted: Object.keys(appState.analysisResults).length,
                    duration: 0 // We don't have the original duration, so use 0
                };
                
                // Restore completed state
                setTimeout(() => {
                    showAnalysisComplete(completionData);
                }, 100);
            }
        }

        function formatSelectableLinks(linksData) {
            console.log('Formatting selectable links. Data:', linksData);
            
            if (!linksData) {
                return '<div class="p-4 bg-red-50 border border-red-200 rounded"><p class="text-red-600">No links data received</p></div>';
            }
            
            if (!linksData.success) {
                const errorMsg = linksData.error || 'Unknown error occurred';
                return `<div class="p-4 bg-red-50 border border-red-200 rounded">
                    <p class="text-red-600 font-semibold">Failed to extract links</p>
                    <p class="text-red-500 text-sm mt-2">Error: ${errorMsg}</p>
                </div>`;
            }
            
            const categorization = linksData.categorization;
            if (!categorization || !categorization.success || !categorization.categorized_links) {
                // Fallback to simple list
                const links = linksData.links || [];
                let html = '<div class="space-y-2">';
                links.forEach((link, index) => {
                    const checkedAttr = '';
                    const disabledAttr = '';
                    const labelClass = 'cursor-pointer';
                    const bgClass = 'hover:bg-gray-50';
                    
                    html += `
                        <div class="flex items-center space-x-3 p-2 ${bgClass} rounded">
                            <input type="checkbox" id="link_${index}" class="w-4 h-4 text-blue-600" onchange="updateSelectedLinks()" data-url="${link.url}" ${checkedAttr} ${disabledAttr}>
                            <label for="link_${index}" class="flex-1 ${labelClass}">
                                <span class="font-medium text-gray-900">${link.text || 'Untitled'}</span>
                                <span class="text-sm text-gray-500 ml-2">${link.url || ''}</span>
                            </label>
                        </div>
                    `;
                });
                html += '</div>';
                return html;
            }
            
            // Display categorized links in template order
            const categorizedLinks = categorization.categorized_links;
            const templateOrder = categorization.template_order || Object.keys(categorizedLinks);
            let html = '';
            
            // Use template order from the dictionary, only show templates with links
            templateOrder.forEach(templateName => {
                const templateLinks = categorizedLinks[templateName];
                if (templateLinks && templateLinks.length > 0) {
                    // Add icons for different template types
                    let icon = '📄';
                    if (templateName.includes('Header')) icon = '🏠';
                    else if (templateName.includes('Footer')) icon = '🔗';
                    else if (templateName.includes('Homepage')) icon = '🏡';
                    else if (templateName.includes('Category')) icon = '📂';
                    else if (templateName.includes('Product')) icon = '🛍️';
                    else if (templateName.includes('Cart')) icon = '🛒';
                    else if (templateName.includes('Account')) icon = '👤';
                    else if (templateName.includes('Search')) icon = '🔍';
                    else if (templateName.includes('Contact')) icon = '📞';
                    else if (templateName === 'Unknown') icon = '❓';
                    
                    html += `
                        <div class="mb-6">
                            <h3 class="text-lg font-medium text-gray-700 mb-3 flex items-center">
                                ${icon} ${templateName} (${templateLinks.length})
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white border border-gray-200 rounded-lg table-fixed">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Select</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Page Name</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/3">Link</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                    `;
                    
                    templateLinks.forEach((link, index) => {
                        const linkId = `link_${templateName.replace(/\s+/g, '_')}_${index}`;
                        const checkedAttr = '';
                        const disabledAttr = '';
                        
                        html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 w-16">
                                    <input type="checkbox" id="${linkId}" class="w-4 h-4 text-blue-600 rounded" onchange="updateSelectedLinks()" data-url="${link.url}" ${checkedAttr} ${disabledAttr}>
                                </td>
                                <td class="px-4 py-2 w-1/3">
                                    <span class="font-medium text-gray-900 truncate block">${link.text || 'Untitled'}</span>
                                </td>
                                <td class="px-4 py-2 w-2/3">
                                    <a href="${link.url}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm break-all">${link.url}</a>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            });
            
            // Add Unknown category if it exists and has links
            if (categorizedLinks['Unknown'] && categorizedLinks['Unknown'].length > 0) {
                const templateLinks = categorizedLinks['Unknown'];
                html += `
                    <div class="mb-6">
                        <h3 class="text-lg font-medium text-gray-700 mb-3 flex items-center">
                            ❓ Unknown (${templateLinks.length})
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg table-fixed">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Select</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Page Name</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/3">Link</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                `;
                
                templateLinks.forEach((link, index) => {
                    const linkId = `link_Unknown_${index}`;
                    const checkedAttr = '';
                    const disabledAttr = '';
                    
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 w-16">
                                <input type="checkbox" id="${linkId}" class="w-4 h-4 text-blue-600 rounded" onchange="updateSelectedLinks()" data-url="${link.url}" ${checkedAttr} ${disabledAttr}>
                            </td>
                            <td class="px-4 py-2 w-1/3">
                                <span class="font-medium text-gray-900 truncate block">${link.text || 'Untitled'}</span>
                            </td>
                            <td class="px-4 py-2 w-2/3">
                                <a href="${link.url}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm break-all">${link.url}</a>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }

        function isHomePage(url) {
            if (!url) return false;
            try {
                const urlObj = new URL(url);
                // Check if it's the root path or just the domain
                return urlObj.pathname === '/' || urlObj.pathname === '';
            } catch (e) {
                return false;
            }
        }

        function updateSelectedLinks() {
            const checkboxes = document.querySelectorAll('#linksContainer input[type="checkbox"]:checked');
            const selectedUrls = Array.from(checkboxes).map(cb => cb.dataset.url).filter(url => url);
            
            appState.selectedLinks = selectedUrls;
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn) {
                analyzeBtn.disabled = appState.selectedLinks.length === 0;
                analyzeBtn.textContent = `Analyze (${appState.selectedLinks.length})`;
            }
        }

        async function startAnalysis() {
            if (appState.selectedLinks.length === 0) {
                alert('Please select at least one page to analyze');
                return;
            }
            
            // Disable all URL checkboxes
            const checkboxes = document.querySelectorAll('#linksContainer input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.disabled = true;
            });
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Starting Analysis...';
            
            try {
                // Start the analysis job
                const response = await fetch('/start-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        urls: appState.selectedLinks,
                        headerHeight: appState.discoveryData.sliceHeights.header,
                        footerHeight: appState.discoveryData.sliceHeights.footer
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    appState.phase = 'analysis-results';
                    appState.currentJobId = data.jobId;
                    
                    // Show progress widget on the current page
                    showProgressWidget(data.totalPages);
                    
                    // Start listening to the event stream
                    startEventStream(data.jobId);
                    
                } else {
                    alert(`Error starting analysis: ${data.error}`);
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = `Analyze (${appState.selectedLinks.length})`;
                }
                
            } catch (error) {
                alert(`Error: ${error.message}`);
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = `Analyze (${appState.selectedLinks.length})`;
            }
        }

        function startEventStream(jobId) {
            console.log('Starting EventSource for job:', jobId);
            
            // Close existing event source if any
            if (appState.eventSource) {
                console.log('Closing existing EventSource');
                appState.eventSource.close();
            }
            
            const streamUrl = `/analysis-stream/${jobId}`;
            console.log('Connecting to:', streamUrl);
            appState.eventSource = new EventSource(streamUrl);
            
            appState.eventSource.onopen = function(event) {
                console.log('EventSource connection opened');
            };
            
            appState.eventSource.onmessage = function(event) {
                console.log('EventSource message received:', event.data);
                const data = JSON.parse(event.data);
                handleStreamEvent(data);
            };
            
            appState.eventSource.onerror = function(event) {
                console.error('EventSource error:', event);
                console.log('EventSource readyState:', appState.eventSource.readyState);
                
                // Attempt to reconnect after a delay
                setTimeout(() => {
                    if (appState.currentJobId && appState.phase === 'analysis-results') {
                        console.log('Attempting to reconnect EventSource...');
                        startEventStream(appState.currentJobId);
                    }
                }, 5000);
            };
        }

        function handleStreamEvent(data) {
            console.log('Handling stream event:', data.type, data);
            
            switch (data.type) {
                case 'started':
                    console.log('Analysis started:', data);
                    break;
                    
                case 'page-complete':
                    console.log('Page completed:', data.url);
                    if (data.success) {
                        appState.analysisResults[data.url] = data;
                        updateAnalysisProgress(data);
                        addPageToSidebar(data);
                        
                        // If this is the homepage (full analysis), also add global header/footer analysis
                        if (data.analysisType === 'all' && (data.headerAnalysis || data.footerAnalysis)) {
                            console.log('Homepage with full analysis detected, adding global header/footer analysis');
                            addGlobalAnalysisToSidebar(data);
                        }
                    } else {
                        console.error('Page analysis failed:', data.url, data.error);
                        // Still update progress to show the attempt
                        updateAnalysisProgress(data);
                    }
                    break;
                    
                case 'finished':
                    console.log('Analysis finished:', data);
                    if (appState.eventSource) {
                        appState.eventSource.close();
                        appState.eventSource = null;
                    }
                    showAnalysisComplete(data);
                    break;
                    
                default:
                    console.warn('Unknown event type:', data.type);
            }
        }

        function showProgressWidget(totalPages) {
            // Initialize progress tracking
            appState.processedPages = new Set();
            
            // Show the progress widget
            const progressWidget = document.getElementById('progressWidget');
            const progressIndicator = document.getElementById('progressIndicator');
            const progressBar = document.getElementById('progressBar');
            const currentlyProcessing = document.getElementById('currentlyProcessing');
            const completedList = document.getElementById('completedList');
            
            if (progressWidget) {
                progressWidget.style.display = 'block';
                progressIndicator.textContent = `0 of ${totalPages} completed`;
                progressBar.style.width = '0%';
                currentlyProcessing.textContent = 'Starting analysis...';
                completedList.innerHTML = '';
            }
            
            // Update sidebar to show analysis structure
            updateSidebarForAnalysis();
        }

        function updateAnalysisProgress(pageData) {
            // Count all processed pages (successful + failed)
            if (!appState.processedPages) {
                appState.processedPages = new Set();
            }
            
            if (pageData && pageData.url) {
                appState.processedPages.add(pageData.url);
            }
            
            const completedCount = appState.processedPages.size;
            const totalCount = appState.selectedLinks.length;
            const percentage = Math.min((completedCount / totalCount) * 100, 100);
            
            console.log(`Progress update: ${completedCount}/${totalCount} (${percentage.toFixed(1)}%)`);
            
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            const progressIndicator = document.getElementById('progressIndicator');
            const currentlyProcessing = document.getElementById('currentlyProcessing');
            
            if (progressBar) progressBar.style.width = `${percentage}%`;
            if (progressIndicator) progressIndicator.textContent = `${completedCount} of ${totalCount} completed`;
            if (currentlyProcessing) {
                if (completedCount < totalCount) {
                    currentlyProcessing.textContent = `Processing page ${completedCount + 1} of ${totalCount}...`;
                } else {
                    currentlyProcessing.textContent = `All pages completed!`;
                }
            }
            
            // Add to completed list
            const completedList = document.getElementById('completedList');
            if (completedList && pageData && pageData.url) {
                // Check if already added to avoid duplicates
                const existingItem = completedList.querySelector(`[data-url="${pageData.url}"]`);
                if (!existingItem) {
                    const pageElement = document.createElement('div');
                    pageElement.setAttribute('data-url', pageData.url);
                    
                    if (pageData.success) {
                        pageElement.className = 'flex items-center space-x-2 p-1 bg-green-50 rounded text-sm';
                        pageElement.innerHTML = `
                            <span class="text-green-600 text-xs">✓</span>
                            <a href="#" onclick="showPageAnalysis('${pageData.url}')" class="text-blue-600 hover:text-blue-800 underline text-xs">
                                ${getPageDisplayName(pageData.url)}
                            </a>
                        `;
                    } else {
                        pageElement.className = 'flex items-center space-x-2 p-1 bg-red-50 rounded text-sm';
                        pageElement.innerHTML = `
                            <span class="text-red-600 text-xs">✗</span>
                            <span class="text-red-600 text-xs" title="${pageData.error || 'Analysis failed'}">
                                ${getPageDisplayName(pageData.url)} (Failed)
                            </span>
                        `;
                    }
                    completedList.appendChild(pageElement);
                }
            }
        }
        
        function cleanDescription(description) {
            if (!description) return 'No description available';
            
            // Remove citation artifacts like [oaicite:77]{index=77}
            return description.replace(/\[oaicite:\d+\]\{index=\d+\}/g, '').trim();
        }

        function renderAIDetectedCustomFeatures(customFeatures, analysisType) {
            if (!customFeatures || customFeatures.length === 0) {
                return '<!-- No AI-detected custom features -->';
            }

            return customFeatures.map((feature, index) => {
                const featureId = `feature_${analysisType}_ai_custom_${index}`;
                
                return `
                    <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded border">
                        <input type="checkbox" 
                               id="${featureId}" 
                               checked
                               class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        
                        <div class="flex-1 grid grid-cols-12 gap-3 items-center">
                            <div class="col-span-2">
                                <input type="text" 
                                       class="w-full text-sm font-bold border border-gray-300 rounded px-2 py-1 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="Feature name"
                                       value="${feature.name || ''}">
                            </div>
                            
                            <div class="col-span-6">
                                <input type="text" 
                                       class="w-full text-sm border border-gray-300 rounded px-2 py-1 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="Feature description"
                                       value="${cleanDescription(feature.description || '')}">
                            </div>
                            
                            <div class="col-span-4">
                                <textarea id="${featureId}_notes" 
                                          class="w-full text-sm border border-gray-300 rounded px-2 py-1 focus:ring-blue-500 focus:border-blue-500" 
                                          rows="1" 
                                          placeholder="Add notes"></textarea>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getPageDisplayName(url) {
            try {
                const urlObj = new URL(url);
                const pathname = urlObj.pathname || '/';
                
                // Show "Home" for homepage instead of "/"
                if (pathname === '/' || pathname === '') {
                    return 'Home';
                }
                
                return pathname.length > 25 ? pathname.substring(0, 25) + '...' : pathname;
            } catch (e) {
                // If URL parsing fails, check if it looks like a homepage
                if (url === '/' || url.endsWith('/')) {
                    return 'Home';
                }
                return url.length > 25 ? url.substring(0, 25) + '...' : url;
            }
        }
        
        function addNewFeature(analysisType) {
            console.log('Adding new feature for analysis type:', analysisType);
            
            // Find the custom features container (now always exists)
            const container = document.getElementById(`custom-features-container-${analysisType}`);
            if (container) {
                addFeatureToContainer(container, analysisType);
            } else {
                console.error('Could not find custom features container for:', analysisType);
            }
        }
        
        function addFeatureToContainer(container, analysisType) {
            const featureCount = container.children.length;
            const featureId = `feature_${analysisType}_custom_${featureCount}`;
            
            const newFeatureHtml = `
                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded border">
                    <input type="checkbox" 
                           id="${featureId}" 
                           checked
                           class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    
                    <div class="flex-1 grid grid-cols-12 gap-3 items-center">
                        <div class="col-span-2">
                            <input type="text" 
                                   class="w-full text-sm font-bold border border-gray-300 rounded px-2 py-1 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="Feature name"
                                   value="">
                        </div>
                        
                        <div class="col-span-6">
                            <input type="text" 
                                   class="w-full text-sm border border-gray-300 rounded px-2 py-1 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="Feature description"
                                   value="">
                        </div>
                        
                        <div class="col-span-4">
                            <textarea id="${featureId}_notes" 
                                      class="w-full text-sm border border-gray-300 rounded px-2 py-1 focus:ring-blue-500 focus:border-blue-500" 
                                      rows="1" 
                                      placeholder="Add notes"></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            const newElement = document.createElement('div');
            newElement.innerHTML = newFeatureHtml;
            
            // Add the new feature to the container (+ button is outside the container now)
            container.appendChild(newElement.firstElementChild);
            
            console.log('Added new feature to container:', container, 'Feature ID:', featureId);
            
            // Focus on the feature name input
            const nameInput = container.lastElementChild.querySelector('input[placeholder="Feature name"]');
            if (nameInput) {
                nameInput.focus();
            }
        }
        

        function updateSidebarForAnalysis() {
            const sidebar = getSidebarElement();
            clearNavLinksCache(); // Clear cache since we're updating the sidebar
            sidebar.innerHTML = `
                <nav>
                    <!-- Site Links section at top -->
                    <div class="mb-4">
                        <a href="#" onclick="showLinkDiscovery()" class="nav-link block px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-200">
                            Site Links
                        </a>
                    </div>
                    
                    <!-- Separator line -->
                    <div class="border-t border-gray-300 mb-4"></div>
                    
                    <!-- Global Header/Footer Analysis -->
                    <div id="globalAnalysisSection" class="mb-4">
                        <div id="globalAnalysisList" class="space-y-1">
                            <!-- Global header/footer links will be added here -->
                        </div>
                    </div>
                    
                    <!-- Separator line -->
                    <div class="border-t border-gray-300 mb-4"></div>
                    
                    <!-- Individual Pages -->
                    <div id="pagesSection">
                        <div id="pagesList" class="space-y-1"></div>
                    </div>
                </nav>
            `;
        }

        function addGlobalAnalysisToSidebar(pageData) {
            const globalAnalysisList = document.getElementById('globalAnalysisList');
            if (!globalAnalysisList || !pageData || !pageData.success) return;
            
            // Add Header link if header analysis exists
            if (pageData.headerAnalysis && pageData.headerAnalysis.success) {
                const existingHeader = globalAnalysisList.querySelector('[data-analysis-type="header"]');
                if (!existingHeader) {
                    const headerElement = document.createElement('a');
                    headerElement.href = '#';
                    headerElement.className = 'nav-link block px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-200';
                    headerElement.setAttribute('data-analysis-type', 'header');
                    headerElement.onclick = () => showGlobalAnalysis('header', pageData);
                    
                    headerElement.innerHTML = `
                        <span class="text-green-600 mr-2 text-xs">✓</span>
                        <span class="text-sm">Header</span>
                    `;
                    
                    globalAnalysisList.appendChild(headerElement);
                    console.log('Added global header analysis to sidebar');
                }
            }
            
            // Add Footer link if footer analysis exists
            if (pageData.footerAnalysis && pageData.footerAnalysis.success) {
                const existingFooter = globalAnalysisList.querySelector('[data-analysis-type="footer"]');
                if (!existingFooter) {
                    const footerElement = document.createElement('a');
                    footerElement.href = '#';
                    footerElement.className = 'nav-link block px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-200';
                    footerElement.setAttribute('data-analysis-type', 'footer');
                    footerElement.onclick = () => showGlobalAnalysis('footer', pageData);
                    
                    footerElement.innerHTML = `
                        <span class="text-green-600 mr-2 text-xs">✓</span>
                        <span class="text-sm">Footer</span>
                    `;
                    
                    globalAnalysisList.appendChild(footerElement);
                    console.log('Added global footer analysis to sidebar');
                }
            }
        }

        function addPageToSidebar(pageData) {
            const pagesList = document.getElementById('pagesList');
            if (!pagesList || !pageData || !pageData.success) return;
            
            // Check if page already exists in sidebar
            const existingPage = pagesList.querySelector(`[data-page-url="${pageData.url}"]`);
            if (existingPage) return;
            
            const pageElement = document.createElement('a');
            pageElement.href = '#';
            pageElement.className = 'nav-link block px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-200';
            pageElement.setAttribute('data-page-url', pageData.url);
            pageElement.onclick = () => showPageAnalysis(pageData.url);
            
            const displayName = getPageDisplayName(pageData.url);
            
            pageElement.innerHTML = `
                <span class="text-green-600 mr-2 text-xs">✓</span>
                <span class="text-sm">${displayName}</span>
            `;
            
            pagesList.appendChild(pageElement);
        }


        function showGlobalAnalysis(analysisType, pageData) {
            const results = document.getElementById('results');
            const analysisData = analysisType === 'header' ? pageData.headerAnalysis : pageData.footerAnalysis;
            
            if (!analysisData || !analysisData.success) {
                results.innerHTML = `<p class="text-red-600">No ${analysisType} analysis available</p>`;
                return;
            }
            
            const imagePath = pageData.images[analysisType];
            // Features are nested in template_analysis.features for header/footer
            const features = analysisData.template_analysis?.features || analysisData.features || [];
            
            console.log(`Showing ${analysisType} analysis:`, analysisData);
            console.log(`Template analysis:`, analysisData.template_analysis);
            console.log(`Features found:`, features);
            
            results.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6 capitalize">${analysisType}</h2>
                        
                        <!-- Screenshot Section -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Screenshot</h3>
                            <img src="${imagePath}" alt="${analysisType} Screenshot" class="mx-auto border border-gray-300 rounded-lg shadow-sm" style="width: 85%;">
                        </div>
                        
                        <!-- Features Section -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Standard Features</h3>
                            ${features.length > 0 ? `
                                <div class="space-y-3">
                                    ${features.map((feature, index) => {
                                        // Check both 'found' (from AI analysis) and 'present' (legacy) fields
                                        const isPresent = feature.found === 'yes' || feature.present === true;
                                        const featureId = `feature_${analysisType}_${index}`;
                                        
                                        return `
                                            <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded border">
                                                <input type="checkbox" 
                                                       id="${featureId}" 
                                                       ${isPresent ? 'checked' : ''} 
                                                       class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                                
                                                <div class="flex-1 grid grid-cols-12 gap-3 items-center">
                                                    <div class="col-span-2">
                                                        <div class="text-sm text-gray-700 font-medium">${feature.name || 'Unnamed Feature'}</div>
                                                    </div>
                                                    
                                                    <div class="col-span-6">
                                                        <div class="text-sm text-gray-600">${cleanDescription(feature.description)}</div>
                                                    </div>
                                                    
                                                    <div class="col-span-4">
                                                        <textarea id="${featureId}_notes" 
                                                                  class="w-full text-sm border border-gray-300 rounded px-2 py-1 focus:ring-blue-500 focus:border-blue-500" 
                                                                  rows="1" 
                                                                  placeholder="Add notes"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <p class="text-yellow-700">No features detected or analysis data unavailable.</p>
                                </div>
                            `}
                            
            <!-- Custom Features Section - Always Visible -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Custom Features</h3>
                <div id="custom-features-container-${analysisType}" class="space-y-3">
                    ${renderAIDetectedCustomFeatures(analysisData.custom_features || [], analysisType)}
                </div>
                <div class="mt-4 flex justify-center">
                    <button onclick="addNewFeature('${analysisType}')" 
                            class="w-8 h-8 flex items-center justify-center text-blue-600 hover:text-white hover:bg-blue-600 bg-blue-50 rounded-full border border-blue-300 hover:border-blue-600 transition-all duration-200 text-lg font-medium">
                        +
                    </button>
                </div>
            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showBodyOnlyAnalysis(pageData) {
            const results = document.getElementById('results');
            const bodyAnalysis = pageData.bodyAnalysis;
            
            if (!bodyAnalysis || !bodyAnalysis.success) {
                results.innerHTML = `<p class="text-red-600">No body analysis available for this page</p>`;
                return;
            }
            
            const imagePath = pageData.images.body;
            // Features are nested in template_analysis.features for body analysis
            const features = bodyAnalysis.template_analysis?.features || bodyAnalysis.features || [];
            const templateName = bodyAnalysis.template_name || 'Unknown Template';
            
            console.log(`Showing body analysis for ${pageData.url}:`, bodyAnalysis);
            console.log(`Template analysis:`, bodyAnalysis.template_analysis);
            console.log(`Features found:`, features);
            
            results.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">${getPageDisplayName(pageData.url)}</h2>
                        <p class="text-gray-600 mb-6">Template: <span class="font-semibold text-blue-600">${templateName}</span></p>
                        
                        <!-- Screenshot Section -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Screenshot</h3>
                            <img src="${imagePath}" alt="Body Screenshot" class="mx-auto border border-gray-300 rounded-lg shadow-sm" style="width: 85%;">
                        </div>
                        
                        <!-- Features Section -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Standard Features</h3>
                            ${features.length > 0 ? `
                                <div class="space-y-3">
                                    ${features.map((feature, index) => {
                                        // Check both 'found' (from AI analysis) and 'present' (legacy) fields
                                        const isPresent = feature.found === 'yes' || feature.present === true;
                                        const featureId = `feature_body_${index}`;
                                        
                                        return `
                                            <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded border">
                                                <input type="checkbox" 
                                                       id="${featureId}" 
                                                       ${isPresent ? 'checked' : ''} 
                                                       class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                                
                                                <div class="flex-1 grid grid-cols-12 gap-3 items-center">
                                                    <div class="col-span-2">
                                                        <div class="text-sm text-gray-700 font-medium">${feature.name || 'Unnamed Feature'}</div>
                                                    </div>
                                                    
                                                    <div class="col-span-6">
                                                        <div class="text-sm text-gray-600">${cleanDescription(feature.description)}</div>
                                                    </div>
                                                    
                                                    <div class="col-span-4">
                                                        <textarea id="${featureId}_notes" 
                                                                  class="w-full text-sm border border-gray-300 rounded px-2 py-1 focus:ring-blue-500 focus:border-blue-500" 
                                                                  rows="1" 
                                                                  placeholder="Add notes"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <p class="text-yellow-700">No features detected or analysis data unavailable.</p>
                                </div>
                            `}
                            
            <!-- Custom Features Section - Always Visible -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Custom Features</h3>
                <div id="custom-features-container-body" class="space-y-3">
                    ${renderAIDetectedCustomFeatures(pageData.bodyAnalysis?.custom_features || [], 'body')}
                </div>
                <div class="mt-4 flex justify-center">
                    <button onclick="addNewFeature('body')" 
                            class="w-8 h-8 flex items-center justify-center text-blue-600 hover:text-white hover:bg-blue-600 bg-blue-50 rounded-full border border-blue-300 hover:border-blue-600 transition-all duration-200 text-lg font-medium">
                        +
                    </button>
                </div>
            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showPageAnalysis(url) {
            const pageData = appState.analysisResults[url];
            if (!pageData) {
                console.error('No page data found for URL:', url);
                return;
            }
            
            // For pages with only body analysis, show body directly
            if (pageData.analysisType === 'body') {
                showBodyOnlyAnalysis(pageData);
            } else {
                // For full analysis (homepage), show body analysis directly
                showBodyOnlyAnalysis(pageData);
            }
            
            // Update active nav state
            updateNavActiveState();
        }

        function showAnalysisComplete(data) {
            // Update progress widget to show completion
            const progressWidget = document.getElementById('progressWidget');
            const progressIndicator = document.getElementById('progressIndicator');
            const progressBar = document.getElementById('progressBar');
            const currentlyProcessing = document.getElementById('currentlyProcessing');
            
            if (progressWidget) {
                // Update progress widget styling to green (complete)
                progressWidget.className = 'mb-6 p-4 bg-green-50 border border-green-200 rounded-lg';
                
                // Update progress text and bar
                progressIndicator.innerHTML = `<span class="text-green-600 font-semibold">✅ Complete</span>`;
                progressBar.style.width = '100%';
                progressBar.className = 'h-2 bg-green-500 rounded transition-all duration-300';
                currentlyProcessing.innerHTML = `<span class="text-green-700">Analysis finished! Processed ${data.totalCompleted} pages in ${Math.round(data.duration / 1000)} seconds</span>`;
            }
            
            // Disable all checkboxes but preserve checked state for selected pages
            const checkboxes = document.querySelectorAll('#linksContainer input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                // Keep the checkbox checked if it was selected for analysis
                const url = checkbox.dataset.url;
                if (appState.selectedLinks && appState.selectedLinks.includes(url)) {
                    checkbox.checked = true;
                }
                checkbox.disabled = true;
            });
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn) {
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'Analysis Complete';
                analyzeBtn.className = 'px-6 py-2 bg-green-600 text-white rounded-lg cursor-not-allowed opacity-75';
            }
            
            // Disable URL input if still visible
            const urlInput = document.getElementById('urlInput');
            const submitBtn = document.getElementById('submitBtn');
            if (urlInput) urlInput.disabled = true;
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Analysis Complete';
            }
        }
        
        let currentData = null;
        let currentPage = 'fullpage';
        let appState = {
            phase: 'landing', // 'landing', 'link-discovery', 'analysis-results'
            discoveryData: null,
            selectedLinks: [],
            analysisResults: {},
            currentJobId: null,
            eventSource: null
        };

        function displayResults(data) {
            currentData = data;
            
            // Show sidebar
            document.getElementById('sidebar').style.display = 'block';
        }

        function showPage(page) {
            if (!currentData) return;
            
            currentPage = page;
            const results = document.getElementById('results');
            
            // Update navigation active state
            updateNavActiveState();
            document.querySelector(`[data-page="${page}"]`).classList.add('bg-blue-100', 'text-blue-700');
            document.querySelector(`[data-page="${page}"]`).classList.remove('text-gray-700');
            
            let html = '';
            
            switch(page) {
                case 'fullpage':
                    html += `<div class="mb-8">`;
                    html += `<h1 class="text-3xl font-bold text-gray-800 mb-6">Full Page Screenshot</h1>`;
                    html += `<div class="flex justify-center">`;
                    html += `<img src="${currentData.images.full}" alt="Full page screenshot" class="max-w-full h-auto shadow-lg rounded-lg border">`;
                    html += `</div>`;
                    html += `</div>`;
                    break;
                    
                case 'sitelinks':
                    html += `<div class="mb-8">`;
                    html += `<h1 class="text-3xl font-bold text-gray-800 mb-6">Site Links</h1>`;
                    
                    // Site links analysis
                    if (currentData.siteLinksAnalysis) {
                        html += `<div class="bg-gray-50 p-6 rounded-lg border">`;
                        html += formatSiteLinks(currentData.siteLinksAnalysis);
                        html += `</div>`;
                    } else {
                        html += `<p class="text-gray-600">Site links analysis not available.</p>`;
                    }
                    
                    html += `</div>`;
                    break;
                    
                case 'header':
                    html += `<div class="mb-8">`;
                    html += `<h1 class="text-3xl font-bold text-gray-800 mb-6">Header</h1>`;
                    
                    // Header image
                    html += `<div class="mb-8">`;
                    html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">Screenshot</h2>`;
                    html += `<div class="flex justify-center">`;
                    html += `<img src="${currentData.images.header}" alt="Header screenshot" class="w-3/4 h-auto shadow-lg rounded-lg border">`;
                    html += `</div>`;
                    html += `</div>`;
                    
                    // Header template analysis
                    if (currentData.headerAnalysis) {
                        html += `<div class="mb-8">`;
                        html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">Features</h2>`;
                        html += `<div class="bg-gray-50 p-6 rounded-lg border">`;
                        html += formatTemplateAnalysis(currentData.headerAnalysis);
                        html += `</div>`;
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                    break;
                    
                case 'body':
                    html += `<div class="mb-8">`;
                    html += `<h1 class="text-3xl font-bold text-gray-800 mb-6">Body</h1>`;
                    
                    // Body image
                    html += `<div class="mb-8">`;
                    html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">Screenshot</h2>`;
                    html += `<div class="flex justify-center">`;
                    html += `<img src="${currentData.images.body}" alt="Body screenshot" class="w-3/4 h-auto shadow-lg rounded-lg border">`;
                    html += `</div>`;
                    html += `</div>`;
                    
                    // Body template analysis
                    if (currentData.bodyAnalysis) {
                        html += `<div class="mb-8">`;
                        
                        // Check if analysis failed completely
                        if (!currentData.bodyAnalysis.success) {
                            html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">Analysis Error</h2>`;
                            html += `<div class="bg-red-50 p-6 rounded-lg border border-red-200">`;
                            html += `<div class="flex items-center mb-3">`;
                            html += `<span class="text-red-600 text-lg font-semibold">❌ Analysis Failed</span>`;
                            html += `</div>`;
                            html += `<p class="text-gray-700">${currentData.bodyAnalysis.error || 'Unknown error occurred during analysis'}</p>`;
                            html += `</div>`;
                        }
                        // Check if template was detected with insufficient confidence
                        else if (currentData.bodyAnalysis.template_not_known) {
                            html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">Template Analysis</h2>`;
                            html += `<div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">`;
                            html += `<div class="flex items-center mb-3">`;
                            html += `<span class="text-yellow-600 text-lg font-semibold">⚠️ Page Template Not Known</span>`;
                            html += `</div>`;
                            html += `<p class="text-gray-700 mb-2"><strong>Detected Template:</strong> ${currentData.bodyAnalysis.template_name || 'Unknown'}</p>`;
                            html += `<p class="text-gray-700 mb-2"><strong>Confidence:</strong> ${currentData.bodyAnalysis.confidence_score || 0}/3</p>`;
                            html += `<p class="text-gray-700"><strong>Justification:</strong> ${currentData.bodyAnalysis.justification || 'No justification provided'}</p>`;
                            html += `</div>`;
                        }
                        // Check if we have template-based feature analysis
                        else if (currentData.bodyAnalysis.template_analysis && currentData.bodyAnalysis.template_analysis.features) {
                            // Show template-based feature analysis
                            html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">Template Features</h2>`;
                            html += `<div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">`;
                            html += `<div class="flex items-center justify-between">`;
                            html += `<div>`;
                            html += `<span class="text-blue-800 font-semibold">Template: ${currentData.bodyAnalysis.template_name || 'Unknown'}</span>`;
                            html += `<span class="text-blue-600 ml-2">(Confidence: ${currentData.bodyAnalysis.confidence_score || 0}/3)</span>`;
                            html += `</div>`;
                            html += `</div>`;
                            html += `<p class="text-blue-700 text-sm mt-2">${currentData.bodyAnalysis.justification || ''}</p>`;
                            html += `</div>`;
                            html += `<div class="bg-gray-50 p-6 rounded-lg border">`;
                            html += formatTemplateAnalysis(currentData.bodyAnalysis);
                            html += `</div>`;
                        }
                        // Fallback to old analysis format if available (for backward compatibility)
                        else if (currentData.bodyAnalysis.analysis) {
                            html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">Interactive Elements</h2>`;
                            html += `<div class="bg-gray-50 p-6 rounded-lg border">`;
                            html += formatAIAnalysis(currentData.bodyAnalysis);
                            html += `</div>`;
                        }
                        // No valid analysis data found
                        else {
                            html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">Analysis Unavailable</h2>`;
                            html += `<div class="bg-gray-50 p-6 rounded-lg border">`;
                            html += `<p class="text-gray-600">No analysis data available for this body content.</p>`;
                            html += `</div>`;
                        }
                        
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                    break;
                    
                case 'footer':
                    html += `<div class="mb-8">`;
                    html += `<h1 class="text-3xl font-bold text-gray-800 mb-6">Footer</h1>`;
                    
                    // Footer image
                    html += `<div class="mb-8">`;
                    html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">Screenshot</h2>`;
                    html += `<div class="flex justify-center">`;
                    html += `<img src="${currentData.images.footer}" alt="Footer screenshot" class="w-3/4 h-auto shadow-lg rounded-lg border">`;
                    html += `</div>`;
                    html += `</div>`;
                    
                    // Footer template analysis
                    if (currentData.footerAnalysis) {
                        html += `<div class="mb-8">`;
                        html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">Features</h2>`;
                        html += `<div class="bg-gray-50 p-6 rounded-lg border">`;
                        html += formatTemplateAnalysis(currentData.footerAnalysis);
                        html += `</div>`;
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                    break;
            }
            
            results.innerHTML = html;
        }
        
        function formatSiteLinks(analysis) {
            if (!analysis || !analysis.success) {
                return '<p class="text-red-600 text-lg">Site links analysis failed</p>';
            }
            
            const links = analysis.links || [];
            if (links.length === 0) {
                return '<p class="text-gray-600">No links found.</p>';
            }
            
            let html = '';
            
            // Check if we have categorization data
            const categorization = analysis.categorization;
            if (categorization && categorization.success && categorization.categorized_links) {
                html += `<div class="mb-6">`;
                html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">Links Categorized by Template</h2>`;
                
                const categorizedLinks = categorization.categorized_links;
                
                // Display each template category in dictionary order
                const templateOrder = categorization.template_order || Object.keys(categorizedLinks);
                
                templateOrder.forEach(templateName => {
                    const templateLinks = categorizedLinks[templateName];
                    if (templateLinks && templateLinks.length > 0) {
                        html += `<div class="mb-6 bg-white p-4 rounded-lg border border-gray-200">`;
                        html += `<h3 class="text-lg font-medium text-gray-700 mb-3 flex items-center">`;
                        
                        // Add icons for different template types
                        let icon = '📄';
                        if (templateName.includes('Header')) icon = '🏠';
                        else if (templateName.includes('Footer')) icon = '🔗';
                        else if (templateName.includes('Homepage')) icon = '🏡';
                        else if (templateName.includes('Category')) icon = '📂';
                        else if (templateName.includes('Product')) icon = '🛍️';
                        else if (templateName.includes('Cart')) icon = '🛒';
                        else if (templateName.includes('Account')) icon = '👤';
                        else if (templateName.includes('Search')) icon = '🔍';
                        else if (templateName.includes('Contact')) icon = '📞';
                        else if (templateName === 'Unknown') icon = '❓';
                        
                        html += `${icon} ${templateName} (${templateLinks.length})`;
                        html += `</h3>`;
                        
                        html += `<div class="overflow-x-auto">`;
                        html += `<table class="min-w-full bg-white border border-gray-200 rounded-lg table-fixed">`;
                        html += `<thead class="bg-gray-50">`;
                        html += `<tr>`;
                        html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Page Name</th>`;
                        html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/3">Link</th>`;
                        html += `</tr>`;
                        html += `</thead>`;
                        html += `<tbody class="divide-y divide-gray-200">`;
                        
                        templateLinks.forEach(link => {
                            const linkText = link.text || 'Untitled Link';
                            const linkUrl = link.url || '#';
                            
                            html += `<tr class="hover:bg-gray-50">`;
                            html += `<td class="px-4 py-2 w-1/3"><span class="font-medium text-gray-900 truncate block">${linkText}</span></td>`;
                            html += `<td class="px-4 py-2 w-2/3"><a href="${linkUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm break-all">${linkUrl}</a></td>`;
                            html += `</tr>`;
                        });
                        
                        html += `</tbody>`;
                        html += `</table>`;
                        html += `</div>`;
                        html += `</div>`;
                    }
                });
                
                // Add Unknown category if it exists and has links
                if (categorizedLinks['Unknown'] && categorizedLinks['Unknown'].length > 0) {
                    const templateLinks = categorizedLinks['Unknown'];
                    html += `<div class="mb-6 bg-white p-4 rounded-lg border border-gray-200">`;
                    html += `<h3 class="text-lg font-medium text-gray-700 mb-3 flex items-center">`;
                    html += `❓ Unknown (${templateLinks.length})`;
                    html += `</h3>`;
                    
                    html += `<div class="overflow-x-auto">`;
                    html += `<table class="min-w-full bg-white border border-gray-200 rounded-lg table-fixed">`;
                    html += `<thead class="bg-gray-50">`;
                    html += `<tr>`;
                    html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Page Name</th>`;
                    html += `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/3">Link</th>`;
                    html += `</tr>`;
                    html += `</thead>`;
                    html += `<tbody class="divide-y divide-gray-200">`;
                    
                    templateLinks.forEach(link => {
                        const linkText = link.text || 'Untitled Link';
                        const linkUrl = link.url || '#';
                        
                        html += `<tr class="hover:bg-gray-50">`;
                        html += `<td class="px-4 py-2 w-1/3"><span class="font-medium text-gray-900 truncate block">${linkText}</span></td>`;
                        html += `<td class="px-4 py-2 w-2/3"><a href="${linkUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm break-all">${linkUrl}</a></td>`;
                        html += `</tr>`;
                    });
                    
                    html += `</tbody>`;
                    html += `</table>`;
                    html += `</div>`;
                    html += `</div>`;
                }
                
                html += `</div>`;
                
                // Add a separator and show all links as well
                html += `<div class="border-t pt-6">`;
                html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">All Links (${links.length})</h2>`;
            } else {
                // Fallback to original display if categorization failed
                html += `<div class="mb-6">`;
                html += `<h2 class="text-2xl font-semibold text-gray-800 mb-4">All Links (${links.length})</h2>`;
                if (categorization && !categorization.success) {
                    html += `<div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">`;
                    html += `<p class="text-yellow-800 text-sm">⚠️ Link categorization failed: ${categorization.error || 'Unknown error'}</p>`;
                    html += `</div>`;
                }
            }
            
            // Display all links in a simple list
            html += `<div class="bg-gray-50 p-4 rounded-lg border">`;
            html += `<div class="space-y-1">`;
            
            links.forEach(link => {
                const linkText = link.text || 'Untitled Link';
                const linkUrl = link.url || '#';
                
                html += `<div class="flex items-center space-x-2">`;
                html += `<span class="text-gray-400">•</span>`;
                html += `<span class="font-medium text-gray-900">${linkText}</span>`;
                html += `<span class="text-gray-400">→</span>`;
                html += `<a href="${linkUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm break-all">${linkUrl}</a>`;
                html += `</div>`;
            });
            
            html += `</div>`;
            html += `</div>`;
            
            if (categorization && categorization.success) {
                html += `</div>`; // Close the separator div
            } else {
                html += `</div>`; // Close the main div
            }
            
            return html;
        }

        function formatTemplateAnalysis(analysis) {
            if (!analysis || !analysis.success) {
                return '<p class="text-red-600 text-lg">Template analysis failed</p>';
            }
            
            const templateData = analysis.template_analysis;
            if (!templateData || !templateData.features) {
                return '<p class="text-red-600 text-lg">No template features found</p>';
            }
            
            // Helper function to clean description text
            function cleanDescription(description) {
                if (!description) return '';
                // Remove the garbled text like :contentReference[oaicite:1]{index=1}
                return description.replace(/:contentReference\[oaicite:\d+\]\{index=\d+\}/g, '').trim();
            }
            
            let html = '';
            html += `<div class="space-y-2" id="features-container-${currentPage}">`;
            
            templateData.features.forEach((feature, index) => {
                const isFound = feature.found === 'yes';
                const cleanDesc = cleanDescription(feature.description);
                const checkboxId = `feature-${currentPage}-${index}`;
                
                html += `<div class="flex items-start space-x-2 p-2 bg-white rounded border feature-item">`;
                html += `<div class="flex-shrink-0 mt-0.5">`;
                html += `<input type="checkbox" id="${checkboxId}" ${isFound ? 'checked' : ''} class="w-4 h-4 text-gray-400 bg-gray-100 border-gray-300 rounded focus:ring-gray-400 focus:ring-2">`;
                html += `</div>`;
                html += `<div class="flex-1">`;
                html += `<span class="font-bold text-gray-700 editable-name cursor-text hover:bg-gray-100 px-1 rounded" onclick="makeEditable(this)" data-original="${feature.name}">${feature.name}</span>`;
                html += ` - `;
                html += `<span class="text-sm text-gray-600 editable-desc cursor-text hover:bg-gray-100 px-1 rounded" onclick="makeEditable(this)" data-original="${cleanDesc}">${cleanDesc}</span>`;
                html += `</div>`;
                html += `</div>`;
            });
            
            // Add the + button to add new items
            html += `<div class="flex justify-center mt-4">`;
            html += `<button onclick="addNewFeature('${currentPage}')" class="flex items-center justify-center w-8 h-8 bg-green-100 hover:bg-green-200 text-green-600 rounded-full transition-colors duration-200">`;
            html += `<span class="text-lg font-bold">+</span>`;
            html += `</button>`;
            html += `</div>`;
            
            html += `</div>`;
            
            return html;
        }

        function formatAIAnalysis(analysis) {
            if (!analysis || !analysis.success) {
                return '<p class="text-red-600 text-lg">AI analysis failed</p>';
            }
            
            const data = analysis.analysis;
            let html = '';
            
            // Helper function to check if URL is valid
            function isValidUrl(url) {
                return url && url !== 'N/A' && url !== 'None' && url !== 'null' && url.trim() !== '';
            }
            
            // Navigation Links by Category
            if (data.navigation_links) {
                html += `<div class="mb-6">`;
                html += `<h3 class="text-lg font-medium text-gray-700 mb-3">Navigation Links</h3>`;
                
                const navLinks = data.navigation_links;
                
                // Product Categories
                if (navLinks.product_categories && navLinks.product_categories.length > 0) {
                    html += `<div class="mb-4">`;
                    html += `<h4 class="text-md font-medium text-gray-600 mb-2">🛍️ Product Categories (${navLinks.product_categories.length})</h4>`;
                    html += `<div class="space-y-1 ml-4">`;
                    navLinks.product_categories.forEach(link => {
                        const url = link.url;
                        const text = link.text || 'N/A';
                        
                        if (isValidUrl(url)) {
                            html += `<div><a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${text}</a>`;
                            if (link.category_type) {
                                html += ` <span class="text-xs text-gray-500">(${link.category_type})</span>`;
                            }
                            html += `</div>`;
                        } else {
                            html += `<div class="text-gray-600">${text}</div>`;
                        }
                    });
                    html += `</div></div>`;
                }
                
                // Content Links
                if (navLinks.content && navLinks.content.length > 0) {
                    html += `<div class="mb-4">`;
                    html += `<h4 class="text-md font-medium text-gray-600 mb-2">📄 Content Links (${navLinks.content.length})</h4>`;
                    html += `<div class="space-y-1 ml-4">`;
                    navLinks.content.forEach(link => {
                        const url = link.url;
                        const text = link.text || 'N/A';
                        
                        if (isValidUrl(url)) {
                            html += `<div><a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${text}</a>`;
                            if (link.content_type) {
                                html += ` <span class="text-xs text-gray-500">(${link.content_type})</span>`;
                            }
                            html += `</div>`;
                        } else {
                            html += `<div class="text-gray-600">${text}</div>`;
                        }
                    });
                    html += `</div></div>`;
                }
                
                // Transactional Links
                if (navLinks.transactional && navLinks.transactional.length > 0) {
                    html += `<div class="mb-4">`;
                    html += `<h4 class="text-md font-medium text-gray-600 mb-2">💳 Transactional Links (${navLinks.transactional.length})</h4>`;
                    html += `<div class="space-y-1 ml-4">`;
                    navLinks.transactional.forEach(link => {
                        const url = link.url;
                        const text = link.text || 'N/A';
                        
                        if (isValidUrl(url)) {
                            html += `<div><a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${text}</a>`;
                            if (link.transaction_type) {
                                html += ` <span class="text-xs text-gray-500">(${link.transaction_type})</span>`;
                            }
                            html += `</div>`;
                        } else {
                            html += `<div class="text-gray-600">${text}</div>`;
                        }
                    });
                    html += `</div></div>`;
                }
                
                // Social Links (for footer analysis)
                if (navLinks.social && navLinks.social.length > 0) {
                    html += `<div class="mb-4">`;
                    html += `<h4 class="text-md font-medium text-gray-600 mb-2">📱 Social Media Links (${navLinks.social.length})</h4>`;
                    html += `<div class="space-y-1 ml-4">`;
                    navLinks.social.forEach(link => {
                        const url = link.url;
                        const text = link.text || 'N/A';
                        
                        if (isValidUrl(url)) {
                            html += `<div><a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${text}</a>`;
                            if (link.social_platform) {
                                html += ` <span class="text-xs text-gray-500">(${link.social_platform})</span>`;
                            }
                            html += `</div>`;
                        } else {
                            html += `<div class="text-gray-600">${text}</div>`;
                        }
                    });
                    html += `</div></div>`;
                }
                
                // Other Links
                if (navLinks.other && navLinks.other.length > 0) {
                    html += `<div class="mb-4">`;
                    html += `<h4 class="text-md font-medium text-gray-600 mb-2">🔗 Other Links (${navLinks.other.length})</h4>`;
                    html += `<div class="space-y-1 ml-4">`;
                    navLinks.other.forEach(link => {
                        const url = link.url;
                        const text = link.text || 'N/A';
                        
                        if (isValidUrl(url)) {
                            html += `<div><a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${text}</a>`;
                            if (link.link_type) {
                                html += ` <span class="text-xs text-gray-500">(${link.link_type})</span>`;
                            }
                            html += `</div>`;
                        } else {
                            html += `<div class="text-gray-600">${text}</div>`;
                        }
                    });
                    html += `</div></div>`;
                }
                
                html += `</div>`;
            }
            
            // Buttons
            if (data.buttons && data.buttons.length > 0) {
                html += `<div class="mb-6">`;
                html += `<h3 class="text-lg font-medium text-gray-700 mb-3">Buttons</h3>`;
                html += `<div class="space-y-2">`;
                data.buttons.forEach(button => {
                    const url = button.url;
                    const text = button.text || 'N/A';
                    
                    if (isValidUrl(url)) {
                        html += `<div><a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${text}</a></div>`;
                    } else {
                        html += `<div class="text-gray-600">${text}</div>`;
                    }
                });
                html += `</div></div>`;
            }
            
            // Interactive Elements
            if (data.interactive_elements && data.interactive_elements.length > 0) {
                html += `<div class="mb-6">`;
                html += `<h3 class="text-lg font-medium text-gray-700 mb-3">Interactive Elements</h3>`;
                html += `<div class="space-y-2">`;
                data.interactive_elements.forEach(element => {
                    const url = element.url;
                    const description = element.description || element.type || 'N/A';
                    
                    if (isValidUrl(url)) {
                        html += `<div><a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${description}</a></div>`;
                    } else {
                        html += `<div class="text-gray-600">${description}</div>`;
                    }
                });
                html += `</div></div>`;
            }
            
            // Branding
            if (data.branding && data.branding.length > 0) {
                html += `<div class="mb-6">`;
                html += `<h3 class="text-lg font-medium text-gray-700 mb-3">Branding Elements</h3>`;
                html += `<div class="space-y-2">`;
                data.branding.forEach(brand => {
                    const url = brand.url;
                    const description = brand.description || brand.type || 'N/A';
                    
                    if (isValidUrl(url)) {
                        html += `<div><a href="${url}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline font-medium">${description}</a></div>`;
                    } else {
                        html += `<div class="text-gray-600">${description}</div>`;
                    }
                });
                html += `</div></div>`;
            }
            
            return html;
        }
        
        // Function to make text editable inline
        function makeEditable(element) {
            // Prevent making already editing elements editable again
            if (element.querySelector('input')) return;
            
            const originalText = element.textContent;
            const isName = element.classList.contains('editable-name');
            
            // Store the original element dimensions to maintain layout
            const originalWidth = element.offsetWidth;
            const originalHeight = element.offsetHeight;
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalText;
            
            // Style the input to match the original element exactly
            if (isName) {
                input.className = 'font-bold text-gray-900 bg-transparent border border-gray-200 outline-none focus:border-gray-300 rounded px-1';
                input.style.width = Math.max(originalWidth, 100) + 'px'; // Minimum width for editing
            } else {
                input.className = 'text-sm text-gray-600 bg-transparent border border-gray-200 outline-none focus:border-gray-300 rounded px-1';
                input.style.width = Math.max(originalWidth, 150) + 'px'; // Minimum width for editing
            }
            
            // Maintain the same height to prevent layout shift
            input.style.height = originalHeight + 'px';
            input.style.minHeight = 'auto';
            
            // Replace the span content with input
            element.innerHTML = '';
            element.appendChild(input);
            
            // Focus and select all text
            input.focus();
            input.select();
            
            // Handle saving on Enter or blur
            function saveEdit() {
                const newText = input.value.trim() || originalText;
                element.innerHTML = newText;
                element.setAttribute('data-original', newText);
                // Reset any inline styles
                element.style.width = '';
                element.style.height = '';
            }
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
            
            // Handle escape to cancel
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    element.innerHTML = originalText;
                    element.style.width = '';
                    element.style.height = '';
                    element.blur();
                }
            });
        }
        
        
        // Allow Enter key to submit
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processUrl();
            }
        });
        
        // Initialize page state - disable URL input if we're past initial submission
        function initializePageState() {
            if (appState.phase === 'link-discovery' || appState.phase === 'analysis-results') {
                const urlInput = document.getElementById('urlInput');
                const submitBtn = document.getElementById('submitBtn');
                
                if (urlInput) {
                    urlInput.disabled = true;
                }
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = appState.phase === 'analysis-results' ? 'Analysis Complete' : 'Discovering Links...';
                }
            }
        }
        
        // Call initialization when page loads
        initializePageState();
    </script>
</body>
</html>
